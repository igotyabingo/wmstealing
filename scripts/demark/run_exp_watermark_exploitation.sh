#!/bin/bash 
 
echo "### START DATE=$(date)" 
echo "### HOSTNAME=$(hostname)" 
echo "### CUDA_VISIBLE_DEVICES=$CUDA_VISIBLE_DEVICES" 
 

source  ~/.bashrc 
conda activate ws
 
export CUDA_LAUNCH_BLOCKING=1

ml unload cuda/11.2 nccl/2.8.4/cuda11.2 
ml load cuda/11.0 nccl/2.8.4/cuda11.0 
ml list 

gpu_num=1

# "meta-llama/Meta-Llama-3.1-8B-Instruct" "meta-llama/Llama-3.2-3B-Instruct" "Qwen/Qwen3-4B-Instruct-2507"
target_model_id='Qwen/Qwen3-4B-Instruct-2507' 
# "meta-llama/Llama-3.2-3B-Instruct" "meta-llama/Llama-3.2-1B-Instruct" "Qwen/Qwen2.5-7B-Instruct"  
surrogate_model_id='Qwen/Qwen2.5-7B-Instruct'
delta_actual=2
delta_predicted=2
delta_reduce_multiplier=1 #eta


max_new_token=300
total_word_num=20
# "dolly_cw" "mmw_book_report" "c4_test"
prompt_set_name="c4_test"

save_dir="./result/spoofing"

export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

set -o allexport
source .env
set +o allexport

huggingface-cli login --token $HUGGINGFACE_TOKEN

cd ./demark

task_num=1
task_idx=0

blackbox=0 # 1 = black box, 0 = gray box

python exp_exploit_watermark.py \
        --task_idx $task_idx \
        --total_task_num $task_num \
        --target_model_id $target_model_id \
        --surrogate_model_id $surrogate_model_id \
        --prompt_set_name $prompt_set_name \
        --delta_actual $delta_actual \
        --delta_predicted $delta_predicted \
        --max_new_token $max_new_token \
        --total_word_num $total_word_num \
        --save_dir $save_dir \
        --blackbox $blackbox

echo "###" 
echo "### END DATE=$(date)"